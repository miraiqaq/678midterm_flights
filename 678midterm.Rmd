---
title: "678midterm"
author: "Xinyi Wang"
date: "11/17/2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#*This is just a draft, will modify and polish after get some feedback*
#Read & Clean Data
```{r warning=FALSE}
setwd("/Users/CindyWang/Desktop/678/midterm_project")
flights <- read.csv("flights.csv")
weather <- read.csv("weather.csv")
airlines <- read.csv("airlines.csv")
flights2 <- read.csv("flights2.csv")
weather2 <- read.csv("weather2.csv")
rank <- read.csv("rank.csv")

library(dplyr)
train_weather <- weather %>%
  dplyr::select(NAME,DATE,WT01,WT02,WT03,WT05,WT08,SNOW,AWND,TAVG,PRCP) %>%
  filter(NAME=="ATLANTA HARTSFIELD INTERNATIONAL AIRPORT, GA US") %>%
  mutate(DAY_OF_MONTH = 1:31)
train_weather[is.na(train_weather)] <- 0

test_weather <- weather2 %>%
  dplyr::select(NAME,DATE,WT01,WT02,WT03,WT05,WT08,SNOW,AWND,TAVG,PRCP) %>%
  filter(NAME=="ATLANTA HARTSFIELD INTERNATIONAL AIRPORT, GA US") %>%
  mutate(DAY_OF_MONTH = 1:31)
test_weather[is.na(test_weather)] <- 0

#TRAIN
##join "flights" and "weather"
flights$X <- NULL
train <- inner_join(flights,train_weather,by="DAY_OF_MONTH")

##join "train" and "airlines" -> train
names(airlines)[names(airlines) == "Code"] <- "OP_UNIQUE_CARRIER"
train <- inner_join(train,airlines,by="OP_UNIQUE_CARRIER")

##join "train" and "rank"
names(rank)[names(rank) == "Code"] <- "OP_UNIQUE_CARRIER"
rank <- rank %>% dplyr::select(OP_UNIQUE_CARRIER,Rank)
train <- inner_join(train,rank,by="OP_UNIQUE_CARRIER")

##change the data class of the filtered data to enable data processing and running algorithms
train$DAY_OF_MONTH <- as.factor(train$DAY_OF_MONTH)
train$DAY_OF_WEEK <- as.factor(train$DAY_OF_WEEK)
# train$DEP_TIME_BLK <- as.factor(train$DEP_TIME_BLK)
train$ORIGIN <- as.character(train$ORIGIN)
train$DEST_STATE_ABR <- as.character(train$DEST_STATE_ABR)

#TEST
##join "flights2" and "weather2"
flights2$X <- NULL
test <- inner_join(flights2,test_weather,by="DAY_OF_MONTH")

##join "test" and "airlines" -> test
names(airlines)[names(airlines) == "Code"] <- "OP_UNIQUE_CARRIER"
test <- inner_join(test,airlines,by="OP_UNIQUE_CARRIER")

##join "train" and "rank"
test <- inner_join(test,rank,by="OP_UNIQUE_CARRIER")

##change the data class of the filtered data to enable data processing and running algorithms
test$DAY_OF_MONTH <- as.factor(test$DAY_OF_MONTH)
test$DAY_OF_WEEK <- as.factor(test$DAY_OF_WEEK)
# train$DEP_TIME_BLK <- as.factor(train$DEP_TIME_BLK)
test$ORIGIN <- as.character(test$ORIGIN)
test$DEST_STATE_ABR <- as.character(test$DEST_STATE_ABR)

##Clean "train"
train$YEAR <- NULL
train$DEP_DELAY_NEW <- NULL
train$ARR_DELAY_NEW <- NULL
train$MONTH <- NULL
train$TAXI_IN <- NULL
train$TAXI_OUT <- NULL
train$WHEELS_ON <- NULL
train$WHEELS_OFF <- NULL
train$CANCELLED <- NULL

##Clean "test"
test$YEAR <- NULL
test$DEP_DELAY_NEW <- NULL
test$ARR_DELAY_NEW <- NULL
test$MONTH <- NULL
test$TAXI_IN <- NULL
test$TAXI_OUT <- NULL
test$WHEELS_ON <- NULL
test$WHEELS_OFF <- NULL
test$CANCELLED <- NULL

train <- train %>% 
  filter(ORIGIN=="ATL") %>%
  mutate(total_delay=DEP_DELAY+ARR_DELAY) %>%
  na.omit()

test <- test %>% 
  filter(ORIGIN=="ATL") %>%
  mutate(total_delay=DEP_DELAY+ARR_DELAY) %>%
  na.omit()
  

```

#EDA
1.This figure shows that the distribution of the outcome is right skewed, it has long tail in the high values. 
And we can see from the plot that most of flights are delay less than 25min but there are some outliers(flight delay alomost 3000min).
```{r}
library(ggplot2)
ggplot(data = train, aes(x=total_delay)) +
  geom_histogram(color="blue", bins = 500) +
  geom_vline(aes(xintercept=mean(total_delay)),
            color="red", linetype="dashed", size=1) +
  labs(title="Distribution of total delay") +
  theme_gray()
mean(train$total_delay)
```

```{r}
# train$delay_pos<-train$total_delay
# train$delay_pos[train$total_delay<=0]<-0
# 
# ggplot(data = train, aes(x=DAY_OF_MONTH,y=log10(delay_pos/60),color=factor(OP_UNIQUE_CARRIER))) +
#   geom_point(alpha=0.1) +
#   labs(title="Distribution of total delay") +
#   geom_smooth(method="lm",se=FALSE)+ theme(legend.position="none")+
#   theme_gray()
# 
#  geom_vline(aes(xintercept=mean(total_delay)),
#             color="red", linetype="dashed", size=1) +


# library(ggplot2)
# ggplot(data = train[train$total_delay>0,], aes(x=(total_delay/60)^(-1/5))) +
#   geom_histogram(color="blue", bins = 500) +
#   geom_vline(aes(xintercept=mean(total_delay)),
#             color="red", linetype="dashed", size=1) +
#   labs(title="Distribution of total delay")
```
2.
```{r}
carrier_count <- train %>%
  dplyr::select(Description,ARR_DEL15) %>%
  group_by(Description) %>%
  summarise(total=n(),delay=sum(ARR_DEL15==1),percentage=(delay/total))

carrier_bar <- ggplot(carrier_count,aes(x=reorder(Description,percentage),
                                        y=percentage,fill=Description)) +
  geom_bar(stat="identity") +
  xlab("Airlines") +
  ylab("Delay Rate(num. of delay(>15min) / total flights of specific airline)") +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  theme_gray() +
  theme(legend.position="none")

  
carrier_bar
```

3. 
```{r}
train <- train %>% 
  mutate(TimeOfDay = cut(DEP_TIME, c(0, 600, 1200, 1800, 2400), 
                     labels = c("Midnight", "Morning", "Afternoon","Evening"), right = TRUE))

timeofday_count <- train %>%
  dplyr::select(TimeOfDay,ARR_DEL15) %>%
  group_by(TimeOfDay) %>%
  summarise(total=n(),delay=sum(ARR_DEL15==1),percentage=(delay/total))

timeofday_bar <- ggplot(timeofday_count,aes(x=TimeOfDay,y=percentage,fill=TimeOfDay)) +
  geom_bar(stat="identity") +
  xlab("Time Of Day") +
  ylab("Delay Rate") +
  scale_y_continuous(labels = scales::percent) +
  theme_gray()
timeofday_bar

```

4.
```{r}
dayofweek_count <- train %>%
  dplyr::select(DAY_OF_WEEK,ARR_DEL15) %>%
  group_by(DAY_OF_WEEK) %>%
  summarise(total=n(),delay=sum(ARR_DEL15==1),percentage=(delay/total))

dayofweek_bar <- ggplot(dayofweek_count,aes(x=DAY_OF_WEEK,y=percentage,fill=DAY_OF_WEEK)) +
  geom_bar(stat="identity") +
  xlab("Day of Week") +
  ylab("Delay Rate") +
  scale_y_continuous(labels = scales::percent) +
  theme_gray()
dayofweek_bar
```

5.This figure shows scatter plots of the predictors against the outcome along with a regression line from a flexible “smoother” model. According to these two figures, we can assume that the relationship between the predictors and the outcome is linear.
```{r}
library(cowplot) #Arranging plots in a grid
fig1 <- ggplot(data=train, aes(x = AIR_TIME, y = total_delay)) +
  geom_point(color ="deeppink2")+
  geom_smooth(se=F)+
  labs( x="Air Time(min)", y="Departure + arrival delays(min)")+
  theme_bw()

fig2 <- ggplot(data=train, aes(x = TAVG, y = total_delay)) +
  geom_point(color ="deepskyblue3")+
  geom_smooth(se=F)+
  labs( x="Avg Temp(F)", y="Departure + arrival delays(min)")+
  theme_bw()

plot_grid(fig1, fig2)
```

6. correlation
```{r}
train$WT01 <- as.factor(train$WT01)
train$WT02 <- as.factor(train$WT02)
train$WT03 <- as.factor(train$WT03)
train$WT05 <- as.factor(train$WT05)
train$WT08 <- as.factor(train$WT08)
train$SNOW <- as.numeric(train$SNOW)
data.num <- Filter(is.numeric, train)
data.num$DEP_TIME <- NULL
data.num$DEP_DELAY <- NULL
data.num$DEP_DELAY_GROUP <- NULL
data.num$ARR_TIME <- NULL
data.num$ARR_DELAY <- NULL
data.num$ARR_DELAY_GROUP <- NULL
data.num$SNOW <- NULL
correlations <- cor(data.num)
# dim(correlations)
# print(correlations)

library(corrplot)
corrplot(correlations,method="circle")

##The variables "DEP_DEL15" and "AIR_TIME" are highly correlated with others predictors.
# train <- train %>% select(-DEP_DEL15,-AIR_TIME)
```

7.U.S heat map
```{r}
library(usmap)
library(ggplot2)

dest_count <- train %>%
  dplyr::select(DEST_STATE_ABR,ARR_DEL15) %>%
  group_by(DEST_STATE_ABR) %>%
  summarise(total=n(),delay=sum(ARR_DEL15==1),percentage=(delay/total)*100)
dest_count <- as.data.frame(dest_count)
names(dest_count)[names(dest_count) == 'DEST_STATE_ABR'] <- 'state'

plot_usmap(data = dest_count, values = "percentage", lines = "red") + 
  scale_fill_continuous(low = "white", high = "red",name = "Delay Rate", 
                        label = scales::comma) + 
  theme(legend.position = "right")
```

#Feature Selection
```{r}
# str(train)
##change the data class of the filtered data to enable data processing and running algorithms
train$OP_UNIQUE_CARRIER <- as.factor(train$OP_UNIQUE_CARRIER)
train$DEST_STATE_ABR <- as.factor(train$DEST_STATE_ABR)
train$ARR_DEL15 <- as.factor(train$ARR_DEL15)
train$WT01 <- as.factor(train$WT01)
train$WT02 <- as.factor(train$WT02)
train$WT05 <- as.factor(train$WT05)
train$WT08 <- as.factor(train$WT08)
train$DEST <- as.factor(train$DEST)
train$Rank <- as.factor(train$Rank)

##Clean
train$ORIGIN <- NULL
train$ORIGIN_CITY_NAME <- NULL
train$ORIGIN_STATE_ABR <- NULL
train$DEST_CITY_NAME <- NULL
train$DEP_TIME <- NULL
train$ARR_TIME <- NULL
train$NAME <- NULL
train$DATE <- NULL
train$Description <- NULL
train$WT03 <- NULL
train$WT05 <- NULL
train$WT08 <- NULL
train$DEP_DELAY_GROUP <- NULL
train$ARR_DELAY_GROUP <- NULL
train$DEST <- NULL

# str(train)

#try 1(keep)
# library(Boruta)
# boruta_output <- Boruta(total_delay~., data = train, doTrace = 2)
# boruta_signif <- names(boruta_output$finalDecision[boruta_output$finalDecision %in% c("Confirmed", "Tentative")])
# print(boruta_signif)
# plot(boruta_output, cex.axis=.5, las=2, xlab="", main="Variable Importance")
## Boruta performed 99 iterations in 6.7969 mins.
## 16 attributes confirmed important: AIR_TIME, ARR_DEL15, ARR_DELAY, AWND, DAY_OF_MONTH and 11 more;
## 2 attributes confirmed unimportant: DEST_STATE_ABR, SNOW;
## 1 tentative attributes left: WT03;

# train <- train %>% select(-DEST_STATE_ABR,-SNOW,-DEP_DELAY,-ARR_DELAY)
train <- train %>% dplyr::select(-DEST_STATE_ABR,-SNOW)

# #try 2
# base.mod <- lm(total_delay ~ 1 , data= train)  # base intercept only model
# all.mod <- lm(total_delay ~ . , data= train) # full model with all predictors
# stepMod <- step(base.mod, scope = list(lower = base.mod, upper = all.mod), direction = "forward", trace = 0)  # perform step-wise algorithm
# shortlistedVars <- names(unlist(stepMod[[1]])) # get the shortlisted variable.
# shortlistedVars <- shortlistedVars[!shortlistedVars %in% "(Intercept)"]  # remove intercept 
# print(shortlistedVars)
# 
# #try 3
# library(randomForest)
# str(train)
# rf=randomForest(total_delay ~ . , data = train)

```


#test sample
```{r}
#use "ARR_DEL15" as y
test <- test %>%
  mutate(TimeOfDay = cut(DEP_TIME, c(0, 600, 1200, 1800, 2400),
                     labels = c("Midnight", "Morning", "Afternoon","Evening"), right = TRUE)) %>%
  dplyr::select(DAY_OF_MONTH,DAY_OF_WEEK,OP_UNIQUE_CARRIER,DEP_DEL15,ARR_DEL15,AIR_TIME,DISTANCE,WT01,WT02,AWND,TAVG,PRCP,TimeOfDay) %>%
  filter(!OP_UNIQUE_CARRIER %in% setdiff(test$OP_UNIQUE_CARRIER,train$OP_UNIQUE_CARRIER))


test$OP_UNIQUE_CARRIER <- as.factor(test$OP_UNIQUE_CARRIER)
test$ARR_DEL15 <- as.factor(test$ARR_DEL15)
test$DEP_DEL15 <- as.factor(test$DEP_DEL15)
test$WT01 <- as.factor(test$WT01)
test$WT02 <- as.factor(test$WT02)
test$DAY_OF_MONTH <- as.numeric(test$DAY_OF_MONTH)
train$DAY_OF_MONTH <- as.numeric(train$DAY_OF_MONTH)


#################
# ##use "total_delay" as y
# test <- test %>% 
#   mutate(TimeOfDay = cut(DEP_TIME, c(0, 600, 1200, 1800, 2400), 
#                      labels = c("Midnight", "Morning", "Afternoon","Evening"), right = TRUE)) %>%
#   select(DAY_OF_MONTH,DAY_OF_WEEK,OP_UNIQUE_CARRIER,ARR_DEL15,DEP_DEL15,AIR_TIME,DISTANCE,WT01,WT02,AWND,TAVG,PRCP,Rank,total_delay,TimeOfDay)
# 
# test$OP_UNIQUE_CARRIER <- as.factor(test$OP_UNIQUE_CARRIER)
# test$ARR_DEL15 <- as.factor(test$ARR_DEL15)
# test$DEP_DEL15 <- as.factor(test$DEP_DEL15)
# test$WT01 <- as.factor(test$WT01)
# test$WT02 <- as.factor(test$WT02)
# test$Rank <- as.factor(test$Rank)
# 
# train <- train %>% select(-DEP_DELAY,-ARR_DELAY)
# train$DAY_OF_WEEK <- as.factor(train$DAY_OF_WEEK)

```



#Model
```{r warning=FALSE}
# str(train)

# ## linear model
# m1 <- lm(total_delay ~ DAY_OF_MONTH + DAY_OF_WEEK + OP_UNIQUE_CARRIER + DEP_DEL15 + ARR_DEL15 +
#            AIR_TIME  + WT01 + WT02 + AWND + TAVG + PRCP + 
#            Rank + TimeOfDay, data = train)
# summary(m1)
# 
# plot(m1, which = 1)
# par(mfrow= c(2,3))
# plot(m1, which = 1:6)
# 
# ## multilevel model
# library(lme4)
# m2 <- lmer(scale(total_delay) ~ DAY_OF_MONTH + DAY_OF_WEEK + DEP_DEL15 + ARR_DEL15 +AIR_TIME + DISTANCE + WT01 + WT02 + AWND + TAVG + PRCP + Rank + TimeOfDay + (1|OP_UNIQUE_CARRIER), data = train)
# summary(m2)


##logistic model
library(car)
library(lme4)
m3 <- glmer(ARR_DEL15 ~ DAY_OF_MONTH  + (1|OP_UNIQUE_CARRIER)  + WT01 + WT02 + AWND + TAVG + PRCP + 
           DAY_OF_WEEK + TimeOfDay + DISTANCE, data = train,  family = binomial(link = "logit"))
summary(m3)
# marginalModelPlots(m3)

m3.predict <- predict(m3, test,type="response")
m3.predict <- ifelse(m3.predict > 0.5,1,0)
head(m3.predict)
m3.predict <- as.factor(m3.predict)
compare <- data.frame(obs = test$ARR_DEL15, pred = m3.predict)

library(caret)
confusionMatrix(m3.predict, test$ARR_DEL15)

library(arm)
binnedplot(fitted(m3),residuals(m3,type="response"))



```







